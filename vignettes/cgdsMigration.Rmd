---
title: "Migrating from cgdsr to cBioPortalData"
author: "Karim Mezhoud & Marcel Ramos"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Migrating from cgdsr to cBioPortalData}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 4
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

<!-- styling  with nowrap DT row -->
<style>
table {
  white-space: nowrap;
}
</style>

# Introduction

This vignette aims to help developers migrate from the now defunct `cgdsr`
CRAN package. Note that the `cgdsr` package code is shown for comparison but it
is not guaranteed to work. If you have questions regarding the contents,
please create an issue at the [GitHub](https://github.com/waldronlab/cBioPortalData/issues) repository.


# Loading the packages

```{r, warning=FALSE, comment=FALSE, message=FALSE}
## Import needed libraries
if (!require("devtools")) install.packages("devtools")
if (!require("BiocManager")) install.packages("BiocManager")
if (!require("cgdsr")) devtools::install_version("cgdsr",version="1.3")
#if (!require("cgdsr")) devtools::install_github("kmezhoud/cgdsr")
if (!require("cBioPortalData")) BiocManager::install("cBioPortalData")
#if (!require("cBioPortalData")) devtools::install_version("cBioPortalData",version="2.7.11")
if (!require("dplyr")) install.packages("dplyr")
if (!require("tidyr")) install.packages("tidyr")
if (!require("DT")) install.packages("DT")
if (!require("tictoc")) install.packages("tictoc")


```

# Discovering studies {.tabset .tabset-fade .tabset-pills}

## `cgdsr`
```{r, comment=FALSE }
cgds <- cgdsr::CGDS("http://www.cbioportal.org/")

getCancerStudies.CGDS(cgds) %>%
    datatable(options = list(pageLength = 5))

```

## `cBioPortalData`

* Here we show the default inputs to the `cBioPortal` function for clarity.

```{r , comment=FALSE, warning=FALSE, message=FALSE}
cbio <- cBioPortal(
    hostname = "www.cbioportal.org",
    protocol = "https",
    api. = "/api/api-docs"
)

getStudies(cbio) %>% 
    select(studyId, everything()) %>%
    datatable(options = list(pageLength = 5))

```


**Note**

* The `studyId` column is important for further queries.

# Obtaining Cases/Patients Identifiers {.tabset .tabset-fade .tabset-pills}

**Definition**

* The Cases is synonym to the Patients. 

* Each patient is identified  by `Case_id`.

* Each patient has one or multiple samples used for molecular/genetic  profile analysis, like mRNA, mutation, CNA, and Methylation.

## `cgdsr`

```{r}

getCaseLists.CGDS(x = cgds,
                  cancerStudy = "gbm_tcga_pub") %>% 
    datatable(options = list(pageLength = 5))

```
**Note**

* Can not query for multiple  `cancerStudy`

## `cBioPortalData`

**Definition**

* Each sample is associated to one or multiple `CaseId`. 

* Each `CaseId` is a Patient. 

* Each patient can participate to one or multiple assays. This means that we can find a `case_id` in multiple `case_list_id`. This is suitable for both `cgdsr` and `cBioPortalData`.

* The `case_list_description` describes the assays.

* `sampleLists` function uses `studyId` as an argument to return case list identifiers. 

* Be attention to `sampleListId` column.


```{r, echo=TRUE}
sampleLists(api = cbio, 
            studyId = "gbm_tcga_pub") %>%
    select(sampleListId, everything()) %>%
    datatable(options = list(pageLength = 5))
```

* Note that a sample list ID is not required when using the
`fetchAllClinicalDataInStudyUsingPOST` internal endpoint. Data for all
patients can be obtained using the `clinicalData` function.

* Can not query for multiple Studies.

* It is possible to get directly `case_ids`. We can use `samplesInSampleLists` function.

```{r}
samplesInSampleLists(api = cbio, 
                     sampleListIds = c("gbm_tcga_pub_expr_classical", "gbm_tcga_pub_expr_mesenchymal") )
```

**Note**

* We can query multiple `case_list_id` to get `case_ids` (samples identifiers)

* To get more information about Patients, we can query with `getSampleInfo` function.

```{r}
getSampleInfo(api = cbio, 
              studyId = "gbm_tcga_pub",
              projection = c("SUMMARY", "ID", "DETAILED", "META")) %>%
    datatable(options = list(pageLength = 5))
```

There may be other endpoints to get Info. Please reefer to section [Endpoits and Search options][Endpoits and Search options of `cBioportalData`]

```{r}
case_ids_1 <- samplesInSampleLists(api = cbio, 
                                   sampleListIds = "gbm_tcga_pub_expr_classical") %>%
                unlist() %>%
                head(1) %>%
                unname()



cbio$getAllClinicalDataOfSampleInStudyUsingGET(
    sampleId = case_ids_1, 
    studyId = "gbm_tcga_pub"
)


```

* Marcel, WHEN WE CAN USE THIS ENDPOINTS? It does not returns Clinical data tibble.

# Obtaining Clinical data of Cases/Patients   {.tabset .tabset-fade .tabset-pills}

## `cgdsr`

* The User needs to specify which samples list from one Study.

* `getClinicalData`  uses `case_list_id` as an argument without specifying the `study_id`.

```{r}
getClinicalData.CGDS(x = cgds, 
                     caseList =  "gbm_tcga_pub_expr_classical") %>%
    datatable(options = list(pageLength = 5))

```

**Note**

* We queried clinical data for `_expr_classical` cases in `gbm_tcga_pub` study id.

## `cBioPortalData`

* Compared to `cgdsr`, `clinicalData` function needs `studyId` and not `case_list_id` to query clinical data sets.

```{r}
## get Clinical data
clinicalData(api = cbio, 
             studyId = "gbm_tcga_pub") %>%
   select(sampleId, everything()) %>%
   datatable(options = list(pageLength = 5))
```

**Note**

* Explicitly we queried a subset (only `_expr_classical`, 54 samples) clinical data with `cgdsr` and all (206 samples) clinical data with `cBioPortalData`.

* **`cBioPortalData` cannot query with `sampleListId` to get a subset of sample list.**

* `cgdsr` returns a dataframe with `sampleId` (TCGA.02.0009.01)  but not `patientId` (TCGA.02.0009)

* `cBioPortalData` returns `sampleId` (TCGA-02-0009-01) & `patientId` (TCGA-02-0009). It uses **dash** instead **dot**.



# get Genetic Profiles or Molecular Profiles Identifiers {.tabset .tabset-fade .tabset-pills}

## `cgdsr`
```{r}
getGeneticProfiles.CGDS(cgds,cancerStudy = "gbm_tcga_pub" ) %>%
    select(genetic_profile_id, genetic_profile_name, everything()) %>%
   datatable(options = list(pageLength = 5))
```

## `cBioPrtalData`

```{r}
molecularProfiles(api = cbio, studyId = "gbm_tcga_pub") %>%
    select(molecularProfileId, name, everything()) %>%
     datatable(options = list(pageLength = 5))
```

# Profile Data or molecular Data (mRNA expression) for a set of  genes {.tabset .tabset-fade .tabset-pills}

## `cgdsr`
```{r}
#tic("cgdsr:")
getProfileData.CGDS(x = cgds,
                    genes = c("NF1", "TP53", "ABL1"),
                    geneticProfiles = "gbm_tcga_pub_mrna",
                    caseList = "gbm_tcga_pub_all") %>%
                     datatable(options = list(pageLength = 5))
#toc()
```

## `cBioPortalData`

Currently, some conversion is needed to directly use the `molecularData`
function, if you only have Hugo symbols. First, convert to Entrez gene IDs
and then obtain all the samples in the sample list of interest.

### Convert gene HugoSymbol to Entrez

It require a `cBioPortalData` version >= `2.7.11`.

```{r, eval=FALSE}
if(packageVersion("cBioPortalData") < "2.7.11") {
  devtools::install_github("waldronlab/cBioPortalData")
}

## convert Hugo Symbol genes to Entrez code
our_entrez <- queryGeneTable(cbio,
                             by = "hugoGeneSymbol",
                             genes = c("NF1", "TP53", "ABL1")
                             )%>%
                             pull(entrezGeneId)
out_entrez
```

**Convert all or selected `genePanelId` to gene Hugo Symbol:**

```{r}
# get all genPanelId
all_genePanelId <- genePanels(api = cbio) %>% pull(genePanelId)


## get all Genes entrez/symbol from all genePanelID, rm duplicates
lapply(X = all_genePanelId,
       function(x) getGenePanel(api = cbio, 
                                genePanelId = x)) %>%
                 bind_rows() %>%
                 distinct() %>%
    datatable(options = list(pageLength = 5))
```

### Three ways to get molecular Data
**(1) `molecularData` function**
```{r, eval=TRUE}

## get mRNA expression
molecularData(api = cbio, 
              molecularProfileIds = "gbm_tcga_pub_mrna",
              entrezGeneIds = c("7157", "25", "4763"), # our_entrez, 
              sampleIds = unlist(samplesInSampleLists(api = cbio,
                                                      sampleListIds = "gbm_tcga_pub_all"))
              )
```

**(2) `getDataByGenes` function**

* Note that this can also be done by using the `getDataByGenes` function, which
automatically figures out all the sample identifiers in the study:

```{r}
getDataByGenes(
    api =  cbio,
    studyId = "gbm_tcga_pub",
    genes = c("NF1", "TP53", "ABL1"),
    by = "hugoGeneSymbol",
    molecularProfileIds = "gbm_tcga_pub_mrna"
) %>%
    .[[1]] %>%
    select(hugoGeneSymbol, value, sampleId) %>%
    tidyr::spread(key = hugoGeneSymbol, value = value) %>%
     datatable(options = list(pageLength = 5))

```

**(3) `cBioPortalData` function**
It is important to note that end users who wish to obtain the data as
easily as possible should use the main `cBioPortalData` function:

NOT WORKING
```{r, eval=FALSE}
cBioPortalData(
    api = cbio,
    studyId = "gbm_tcga_pub",
    genes = c("NF1", "TP53", "ABL1"), 
    by = "hugoGeneSymbol",
    molecularProfileIds = "gbm_tcga_pub_mrna"
) %>%
    .[[1]] %>%
    datatable(options = list(pageLength = 5))
```

# Mutation Data {.tabset .tabset-fade .tabset-pills}

## `cgdsr`

```{r}
getMutationData.CGDS(
    x = cgds, 
    caseList = "getMutationData",
    geneticProfile = "gbm_tcga_pub_mutations",
    genes = c("NF1", "TP53", "ABL1")
) %>%
    select(entrez_gene_id, gene_symbol, case_id, amino_acid_change, reference_allele, variant_allele, functional_impact_score, everything()) %>%
    datatable(options = list(pageLength = 5))
```


## `cBioPortalData`

### Three ways to get molecular Data

**`mutationData` funtion**

Similar to `molecularData`, `mutationData` function  can query mutation data.
```{r}
mutationData(
    api = cbio,
    molecularProfileIds = "gbm_tcga_pub_mutations",
    #by = "hugoGeneSymbol",
    #genes = c("NF1", "TP53", "ABL1"),
    entrezGeneIds = c("7157", "25", "4763"), # our_entrez, 
    sampleIds = unlist(samplesInSampleLists(api = cbio,
                                                      sampleListIds = "gbm_tcga_pub_all"))
) %>%
    .[[1]] %>%
    select(entrezGeneId, sampleId, proteinChange,keyword, referenceAllele, variantAllele, variantType, everything()) %>%
     datatable(options = list(pageLength = 5))
```

**(2) `getDataByGene` function**

 Mutation data can also queried by  the `getDataByGenes` function.

```{r}
getDataByGenes(
    api = cbio,
    studyId = "gbm_tcga_pub",
    genes = c("NF1", "TP53", "ABL1"),
    by = "hugoGeneSymbol",
    molecularProfileIds = "gbm_tcga_pub_mutations"
) %>%
    .[[1]] %>%
        select(entrezGeneId, sampleId, proteinChange,keyword, referenceAllele, variantAllele, variantType, everything()) %>%
    datatable(options = list(pageLength = 5))
```

**(3) `cBioPortalData` function**
NOT WORKING
```{r, eval =FALSE}
cBioPortalData(
    api = cbio,
    studyId = "gbm_tcga_pub",
    genes = c("NF1", "TP53", "ABL1"),
    by = "hugoGeneSymbol",
    molecularProfileIds = "gbm_tcga_pub_mutations"
)
```

# Copy Number Alteration Data (CNA)  {.tabset .tabset-fade .tabset-pills}

## `cgdsr`

## `cBioPortalData`

# Methylation Data  {.tabset .tabset-fade .tabset-pills}

## `cgdsr`

## `cBioPortalData`

# Endpoits and Search options of `cBioportalData`

* `searchOps` function returns all endpoints needed using `regex`. Here some example of endpoints:  


**By Sample endpoint**
```{r}
searchOps(cbio, "sample")
```



**By Clinical endpoint**
```{r}
searchOps(cbio, "clinical")
```


**By molecular endpoint**
```{r}
searchOps(cbio, "molecular")
```

**By profile endpoint**
```{r}
searchOps(cbio, "profile")
```

**By mutation endpoint**

```{r}
searchOps(cbio, "mutation")
```

**By gene endpoint**

```{r}
searchOps(cbio, "gene")

```

